<div class="task-page">
  <!-- ===== Page Header ===== -->
  <div class="page-header">
    <div>
      <h2 class="page-title">Tasks</h2>
      <p class="page-subtitle">Manage and track workflow tasks</p>
    </div>

    <a routerLink="/dashboard/tasks/new" class="btn btn-primary"> + Create Task </a>
  </div>

  <!-- ===== Loading ===== -->
  <div *ngIf="loading$ | async" class="state-card info">Loading tasks...</div>

  <!-- ===== Empty State ===== -->
  <div
    *ngIf="!(loading$ | async) && ((tasks$ | async)?.length ?? 0) === 0"
    class="state-card empty"
  >
    No tasks found.
  </div>

  <!-- ===== Table View (Desktop) ===== -->
  <div
    *ngIf="!(loading$ | async) && ((tasks$ | async)?.length ?? 0) > 0"
    class="table-wrapper d-none d-md-block"
  >
    <table class="custom-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Created By</th>
          <th>Assigned To</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let task of tasks$ | async; trackBy: trackById">
          <td class="title-cell">{{ task.title }}</td>

          <td class="position-relative">
            <span
              class="status-badge"
              [ngClass]="getBadgeClass(task.status)"
              (click)="toggleStatusMenu(task.id)"
            >
              {{ task.status }}
            </span>

            <div *ngIf="openTaskId === task.id" class="status-menu">
              <button
                *ngFor="let next of allowedTransitions[task.status]"
                [disabled]="updatingTaskId === task.id"
                (click)="updateStatus(task, next)"
              >
                → {{ next }}
              </button>

              <div *ngIf="allowedTransitions[task.status].length === 0" class="status-empty">
                No actions available
              </div>
            </div>
          </td>

          <td>{{ task.createdByName || '—' }}</td>
          <td>{{ task.assignedToName || '—' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== Mobile Card View ===== -->
  <div class="d-block d-md-none">
    <div class="task-card" *ngFor="let task of tasks$ | async; trackBy: trackById">
      <div class="task-card-header">
        <h6>{{ task.title }}</h6>

        <span
          class="status-badge"
          [ngClass]="getBadgeClass(task.status)"
          (click)="toggleStatusMenu(task.id)"
        >
          {{ task.status }}
        </span>
      </div>

      <div *ngIf="openTaskId === task.id" class="status-menu-mobile">
        <button
          *ngFor="let next of allowedTransitions[task.status]"
          [disabled]="updatingTaskId === task.id"
          (click)="updateStatus(task, next)"
        >
          → {{ next }}
        </button>

        <div *ngIf="allowedTransitions[task.status].length === 0" class="status-empty">
          No actions available
        </div>
      </div>

      <div class="task-meta">
        <div><strong>Created:</strong> {{ task.createdByName || '—' }}</div>
        <div><strong>Assigned:</strong> {{ task.assignedToName || '—' }}</div>
      </div>
    </div>
  </div>
</div>
